zabbix_export:
  version: '7.2'
  template_groups:
    - uuid: 215abbab93df48cab8aea43b5c915f2d
      name: 'Security Cameras - AllCamers'
  templates:
    - uuid: aef49f641ed64a298a8c03990057b7de
      template: ALL_CAM_Check
      name: ALL_CAM_Check
      templates:
        - name: 'ICMP Ping'
      groups:
        - name: 'Security Cameras - AllCamers'
      tags:
        - tag: service
          value: camera
        - tag: role
          value: surveillance
        - tag: env
          value: '{$CAM_ENV}'
      items:
        - uuid: 77c3d3d384d443d4bbd075fdae70a2e9
          name: 'IP-адрес (внутренний)'
          type: DEPENDENT
          key: cam.address
          value_type: TEXT
          history: 1d
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.Address
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: fa0237cd952242c7b47519f70bec1824
          name: 'Средняя яркость'
          type: DEPENDENT
          key: cam.avg_brightness
          value_type: FLOAT
          trends: '0'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.avg_brightness
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: e5a2fe0bc38548ce85436157da932beb
          name: 'Средний размер кадра (KB)'
          type: DEPENDENT
          key: cam.avg_frame_kb
          value_type: FLOAT
          trends: '0'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.avg_frame_size_kb
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: 589e4acace2f43d689c8a728d63b2335
          name: 'Базовая запись создана'
          type: DEPENDENT
          key: cam.baseline_created
          value_type: TEXT
          history: 1d
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.BaselineCreated
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: 102f45208076474b92d781a6e6e3c018
          name: 'Имя DNS сервера'
          type: DEPENDENT
          key: cam.dns_name
          value_type: TEXT
          history: 1d
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.DNSname
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
          triggers:
            - uuid: 00db56fbc26e495ab730cab0f2631417
              expression: 'count(/ALL_CAM_Check/cam.dns_name,{$CAM_TIMEOUT},"ne","{$CAM_NTP_EXPECTED}")>0'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'count(/ALL_CAM_Check/cam.dns_name,{$CAM_STATUS_RECOVERY_WINDOW},"eq","{$CAM_NTP_EXPECTED}")>={$CAM_STATUS_RECOVERY}'
              name: 'NTP-сервер камеры не соответствует {$CAM_NTP_EXPECTED}'
              event_name: 'NTP-сервер камеры не соответствует {$CAM_NTP_EXPECTED}'
              priority: INFO
              tags:
                - tag: scope
                  value: performance
                - tag: impact
                  value: ntp
                - tag: cause
                  value: configuration
                - tag: subsystem
                  value: time-sync
                - tag: severity
                  value: info
        - uuid: 442ac19512e9446588dddf3fc19fb626
          name: 'Версия прошивки'
          type: DEPENDENT
          key: cam.firmware
          value_type: TEXT
          history: 30d
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.FirmwareVersion
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: 57e017f8f5664b1faf6da539fb658fc3
          name: 'Кадров считано'
          type: DEPENDENT
          key: cam.frames_read
          value_type: UNSIGNED
          units: frames
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.frames_read
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: 2353b34fe5ee462dbfb17b92d188dd8f
          name: 'Hardware ID'
          type: DEPENDENT
          key: cam.hardware_id
          value_type: TEXT
          history: 30d
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.HardwareId
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: ed2ecc8b43a84d0899078fd8f20e4e3d
          name: 'MAC-адрес камеры'
          type: DEPENDENT
          key: cam.hw_mac
          value_type: TEXT
          history: 30d
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.HwAddress
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: 9373bf326d614ae0ad5a4934b2411ef6
          name: 'Производитель камеры'
          type: DEPENDENT
          key: cam.manufacturer
          value_type: TEXT
          history: 30d
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.Manufacturer
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: dc176a8ac0b7489b9c840973611662f3
          name: 'Модель камеры'
          type: DEPENDENT
          key: cam.model
          value_type: TEXT
          history: 30d
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.Model
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: 945bc47f5fd34ff1b0a368afef9285d6
          name: 'Уровень движения'
          type: DEPENDENT
          key: cam.motion_level
          value_type: FLOAT
          trends: '0'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.frame_change_level
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: 97f7d7f815f94d5ca67dbb76d5cb8e1f
          name: 'Диагностика цвета'
          type: DEPENDENT
          key: cam.color_diagnosis
          value_type: CHAR
          history: 7d
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.ColorDiagnosis
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: 6bc846f78a1b4950b50278f2c3e00235
          name: 'Список новых пользователей'
          type: DEPENDENT
          key: cam.new_usernames
          value_type: TEXT
          history: 7d
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.NewUsernames
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: f76391cab3cb492598aa070eb82a0bdd
          name: 'Новые пользователи'
          type: DEPENDENT
          key: cam.new_users
          value_type: TEXT
          history: 7d
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.NewUsersDetected
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
          triggers:
            - uuid: e0e135336bdc40e08cad59aff5677860
              expression: 'count(/ALL_CAM_Check/cam.new_users,{$CAM_TIMEOUT},"eq","true")>0'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'count(/ALL_CAM_Check/cam.new_users,{$CAM_STATUS_RECOVERY_WINDOW},"eq","false")>={$CAM_STATUS_RECOVERY}'
              name: 'Обнаружены новые пользователи'
              event_name: '👤 Обнаружены новые пользователи'
              priority: WARNING
              manual_close: 'YES'
              tags:
                - tag: scope
                  value: security
                - tag: impact
                  value: auth
                - tag: cause
                  value: credentials
                - tag: subsystem
                  value: accounts
                - tag: severity
                  value: warning
        - uuid: 64539dfde250422599556345ef75c34c
          name: 'FPS (кадров/сек)'
          type: DEPENDENT
          key: cam.real_fps
          value_type: FLOAT
          trends: '0'
          units: fps
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.real_fps
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: 4cb8cce579d64175a192ca77b0f8a0e0
          name: 'Время выполнения camcheck.py'
          type: DEPENDENT
          key: cam.execution_seconds
          value_type: FLOAT
          trends: '0'
          units: s
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.ExecutionSeconds
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
          triggers:
            - uuid: c053798b59a14553884e2cd22f2994a5
              expression: 'avg(/ALL_CAM_Check/cam.execution_seconds,{$CAM_STATUS_WINDOW})>{$CAM_RTT_WARN}'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'avg(/ALL_CAM_Check/cam.execution_seconds,{$CAM_STATUS_RECOVERY_WINDOW})<{$CAM_RTT_RECOVERY}'
              name: 'Время выполнения camcheck.py превышает {$CAM_RTT_WARN}s'
              event_name: '⚙️ camcheck.py выполняется дольше {$CAM_RTT_WARN}s'
              priority: WARNING
              tags:
                - tag: scope
                  value: performance
                - tag: impact
                  value: nvps
                - tag: cause
                  value: latency
                - tag: subsystem
                  value: externalscripts
                - tag: severity
                  value: warning
        - uuid: e4fdd22775f54997a85a412057e116a7
          name: 'Разрешение (собранное)'
          type: DEPENDENT
          key: cam.resolution
          value_type: TEXT
          history: 30d
          preprocessing:
            - type: JAVASCRIPT
              parameters:
                - |
                  var data = JSON.parse(value);
                  return data.width + "x" + data.height;
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: b21a99e50079498eba28031086247d71
          name: RTSP-путь
          type: DEPENDENT
          key: cam.rtsp_path
          value_type: TEXT
          history: 30d
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.RTSPPath
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: ec3a1768341e4de5b36a22fc7a08b611
          name: RTSP-порт
          type: DEPENDENT
          key: cam.rtsp_port
          value_type: UNSIGNED
          trends: '0'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.RTSPPort
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: 69df21bf76e849f788f54d7d062fd66a
          name: 'Серийный номер'
          type: DEPENDENT
          key: cam.serial
          value_type: TEXT
          history: 30d
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.SerialNumber
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: 0712ad60cc2345fc9ee18ac91ecdfcd9
          name: 'Статус потока'
          type: DEPENDENT
          key: cam.status
          value_type: CHAR
          history: 7d
          valuemap:
            name: 'Camera stream status'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.status
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
          triggers:
            - uuid: 5f8aa7afc17e4d88bd4c4cf0b2a4e8ae
              expression: 'count(/ALL_CAM_Check/cam.status,{$CAM_STATUS_WINDOW},"eq","unauthorized")>={$CAM_STATUS_AUTH_THRESHOLD}'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'count(/ALL_CAM_Check/cam.status,{$CAM_STATUS_RECOVERY_WINDOW},"eq","ok")>={$CAM_STATUS_RECOVERY}'
              name: 'Попытки несанкционированного доступа к камере'
              event_name: '🚨 Попытки несанкционированного доступа к камере'
              priority: DISASTER
              manual_close: 'YES'
              tags:
                - tag: scope
                  value: security
                - tag: impact
                  value: auth
                - tag: cause
                  value: credentials
                - tag: subsystem
                  value: rtsp-auth
                - tag: severity
                  value: disaster
            - uuid: e6ecb38f2ed04db6b71bd486070897e1
              expression: 'count(/ALL_CAM_Check/cam.status,{$CAM_STATUS_WINDOW},"regexp","error|not_available")>={$CAM_STATUS_ERROR_COUNT}'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'count(/ALL_CAM_Check/cam.status,{$CAM_STATUS_RECOVERY_WINDOW},"eq","ok")>={$CAM_STATUS_RECOVERY}'
              name: 'Проблемы с RTSP потоком'
              event_name: '📡 Камера недоступна'
              priority: AVERAGE
              tags:
                - tag: scope
                  value: performance
                - tag: impact
                  value: rtsp
                - tag: cause
                  value: stream
                - tag: subsystem
                  value: rtsp
                - tag: severity
                  value: average
        - uuid: 7bbe68f20d2947f18e082899a19d9bf6
          name: 'Разница времени (сек.)'
          type: DEPENDENT
          key: cam.time_diff_sec
          value_type: FLOAT
          trends: '0'
          units: s
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.TimeDifferenceSeconds
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
          triggers:
            - uuid: 4d2594045a6b4b308396f069f69fd3e4
              expression: 'max(/ALL_CAM_Check/cam.time_diff_sec,{$CAM_STATUS_WINDOW})>{$CAM_TIME_DRIFT_WARN}'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'avg(/ALL_CAM_Check/cam.time_diff_sec,{$CAM_STATUS_RECOVERY_WINDOW})<{$CAM_TIME_DRIFT_RECOVERY}'
              name: 'Смещение времени камеры превышает {$CAM_TIME_DRIFT_WARN}s'
              event_name: '⏰ Смещение времени камеры превышает {$CAM_TIME_DRIFT_WARN}s'
              priority: AVERAGE
              tags:
                - tag: scope
                  value: performance
                - tag: impact
                  value: time
                - tag: cause
                  value: ntp
                - tag: subsystem
                  value: time-sync
                - tag: severity
                  value: average
        - uuid: 95539e268f664bcf9e26c9e6b3068fc7
          name: 'Синхронизация времени'
          type: DEPENDENT
          key: cam.time_sync_ok
          value_type: CHAR
          history: 7d
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.TimeSyncOK
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
          triggers:
            - uuid: 145cb82f1b254f998d221b718823803c
              expression: 'count(/ALL_CAM_Check/cam.time_sync_ok,{$CAM_TIMEOUT},"eq","false")>0'
              recovery_mode: RECOVERY_EXPRESSION
              recovery_expression: 'count(/ALL_CAM_Check/cam.time_sync_ok,{$CAM_STATUS_RECOVERY_WINDOW},"eq","true")>={$CAM_STATUS_RECOVERY}'
              name: 'Несинхронизированное время'
              event_name: '⏰ Несинхронизированное время'
              priority: WARNING
              type: MULTIPLE
              manual_close: 'YES'
              tags:
                - tag: scope
                  value: performance
                - tag: impact
                  value: time
                - tag: cause
                  value: ntp
                - tag: subsystem
                  value: time-sync
                - tag: severity
                  value: warning
        - uuid: 89ba9e88bbd34665812fafb77794c4c1
          name: 'Кол-во пользователей'
          type: DEPENDENT
          key: cam.user_count
          value_type: UNSIGNED
          history: 30d
          trends: '0'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.UserCount
          master_item:
            key: 'camcheck.py[{HOST.CONN}]'
        - uuid: 054eae93091748c7930e214ef889ebdd
          name: JSON_RAW
          type: EXTERNAL
          key: 'camcheck.py[{HOST.CONN}]'
          delay: 10m
          history: 1d
          value_type: TEXT
      macros:
        - macro: '{$CAM_ENV}'
          value: 'prod'
        - macro: '{$CAMERA_IP}'
          value: '{HOST.CONN}'
        - macro: '{$CAM_NTP_EXPECTED}'
          value: 'ntp.syshleb.ru'
        - macro: '{$CAM_TIMEOUT}'
          value: '30m'
        - macro: '{$CAM_STATUS_WINDOW}'
          value: '30m'
        - macro: '{$CAM_STATUS_ERROR_COUNT}'
          value: '3'
        - macro: '{$CAM_STATUS_AUTH_THRESHOLD}'
          value: '3'
        - macro: '{$CAM_STATUS_RECOVERY}'
          value: '3'
        - macro: '{$CAM_STATUS_RECOVERY_WINDOW}'
          value: '30m'
        - macro: '{$CAM_RTT_WARN}'
          value: '15'
        - macro: '{$CAM_RTT_RECOVERY}'
          value: '10'
        - macro: '{$CAM_TIME_DRIFT_WARN}'
          value: '5'
        - macro: '{$CAM_TIME_DRIFT_RECOVERY}'
          value: '2'
      valuemaps:
        - uuid: 8e13c4b5c28048bfae30119500f0b314
          name: 'Camera stream status'
          mappings:
            - value: ok
              newvalue: 'OK'
            - value: unauthorized
              newvalue: 'Unauthorized'
            - value: not_available
              newvalue: 'Not available'
            - value: error
              newvalue: 'Error'
  triggers:
    - uuid: 24a64ca59d2c4564bfe3b2ee96858b98
      expression: 'change(/ALL_CAM_Check/cam.serial)=1 or change(/ALL_CAM_Check/cam.model)=1'
      name: 'Возможная замена камеры (модель или серийный номер изменились)'
      priority: WARNING
      manual_close: 'YES'
      tags:
        - tag: scope
          value: security
        - tag: impact
          value: integrity
        - tag: cause
          value: hardware
        - tag: subsystem
          value: inventory
        - tag: severity
          value: warning
  dashboards:
    - uuid: 0f6db9496dc74e91a4924c2cf2b497dd
      name: 'Cameras RED/USE'
      auto_start: 'NO'
      display_period: 1h
      filter:
        evaltype: AND
        conditions: []
      pages:
        - name: 'Operations overview'
          widgets:
            - type: TOP_HOSTS
              name: 'Состояние потоков'
              x: '0'
              y: '0'
              width: '8'
              height: '6'
              fields:
                - type: STRING
                  name: group
                  value: 'Security Cameras - AllCamers'
                - type: STRING
                  name: item
                  value: cam.status
                - type: STRING
                  name: function
                  value: last
                - type: STRING
                  name: order
                  value: DESC
                - type: INTEGER
                  name: rows
                  value: '10'
            - type: TOP_HOSTS
              name: 'FPS реального потока'
              x: '8'
              y: '0'
              width: '8'
              height: '6'
              fields:
                - type: STRING
                  name: group
                  value: 'Security Cameras - AllCamers'
                - type: STRING
                  name: item
                  value: cam.real_fps
                - type: STRING
                  name: function
                  value: avg
                - type: STRING
                  name: order
                  value: ASC
                - type: INTEGER
                  name: rows
                  value: '10'
            - type: TOP_HOSTS
              name: 'Движение (cam.motion_level)'
              x: '0'
              y: '6'
              width: '8'
              height: '6'
              fields:
                - type: STRING
                  name: group
                  value: 'Security Cameras - AllCamers'
                - type: STRING
                  name: item
                  value: cam.motion_level
                - type: STRING
                  name: function
                  value: max
                - type: STRING
                  name: order
                  value: DESC
                - type: INTEGER
                  name: rows
                  value: '10'
            - type: DATA_OVERVIEW
              name: 'Диагностика цвета'
              x: '8'
              y: '6'
              width: '8'
              height: '6'
              fields:
                - type: STRING
                  name: group
                  value: 'Security Cameras - AllCamers'
                - type: STRING
                  name: item
                  value: cam.color_diagnosis
                - type: INTEGER
                  name: rows
                  value: '10'
    - uuid: 0a8c7b0c89b949f5901ca230e7c6b1a0
      name: 'Zabbix internals'
      auto_start: 'NO'
      display_period: 1h
      pages:
        - name: 'Server health'
          widgets:
            - type: PROBLEMS
              name: 'Zabbix server problems'
              x: '0'
              y: '0'
              width: '12'
              height: '6'
              fields:
                - type: STRING
                  name: host_group
                  value: 'Zabbix servers'
            - type: TOP_HOSTS
              name: 'Queue length (externalscripts)'
              x: '12'
              y: '0'
              width: '12'
              height: '6'
              fields:
                - type: STRING
                  name: group
                  value: 'Zabbix servers'
                - type: STRING
                  name: item
                  value: 'zabbix[queue,externalscripts]'
                - type: STRING
                  name: function
                  value: max
                - type: STRING
                  name: order
                  value: DESC
                - type: INTEGER
                  name: rows
                  value: '10'
            - type: PLAIN_TEXT
              name: 'Preprocessing backlog'
              x: '0'
              y: '6'
              width: '24'
              height: '4'
              fields:
                - type: TEXT
                  name: text
                  value: 'Добавьте сюда графики из шаблона Zabbix Server: например, history syncer busy %, preprocessing busy % и nvps.'
