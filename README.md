# ONVIF/RTSP Camera Audit Script

üì∑ –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞—É–¥–∏—Ç–∞ IP-–∫–∞–º–µ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ONVIF –∏ RTSP.  
–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Å–∏—Å—Ç–µ–º–∞–º–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞, —Ç–∞–∫–∏–º–∏ –∫–∞–∫ **Zabbix** —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏.

---

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- üîç –ü–æ–∏—Å–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö ONVIF-–ø–æ—Ä—Ç–æ–≤ –∏ —Ä–∞–±–æ—á–∏—Ö —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–ø–µ—Ä–µ–±–æ—Ä –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π).
- üìú –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–º–µ—Ä–µ:
  - –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å (Manufacturer)
  - –ú–æ–¥–µ–ª—å (Model)
  - –í–µ—Ä—Å–∏—è –ø—Ä–æ—à–∏–≤–∫–∏ (FirmwareVersion)
  - –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä (SerialNumber)
  - –ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–π ID (HardwareId)
- üåê –°–±–æ—Ä —Å–µ—Ç–µ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫:
  - MAC-–∞–¥—Ä–µ—Å
  - IP-–∞–¥—Ä–µ—Å
  - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ NTP –∏ DNS
- ‚è± –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ —Å –∫–∞–º–µ—Ä–æ–π (–¥–æ–ø—É—Å—Ç–∏–º–æ–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è).
- üë• –ê—É–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–∞–º–µ—Ä—ã:
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–π –ª–∏–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
  - –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —É—á–µ—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.
- üé• –ü—Ä–æ–≤–µ—Ä–∫–∞ RTSP-–ø–æ—Ç–æ–∫–∞:
  - –ó–∞—Ö–≤–∞—Ç –∫–∞–¥—Ä–æ–≤ —Å –∞–Ω–∞–ª–∏–∑–æ–º (—Ä–∞–∑–º–µ—Ä –∫–∞–¥—Ä–∞, —è—Ä–∫–æ—Å—Ç—å, –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–µ–∂–¥—É –∫–∞–¥—Ä–∞–º–∏, FPS).
  - –§–æ–ª–±—ç–∫ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ç–æ–∫–∞ —á–µ—Ä–µ–∑ `ffprobe`, –µ—Å–ª–∏ OpenCV –Ω–µ —Å–ø—Ä–∞–≤–∏–ª—Å—è.

---

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:
    ```bash
    pip install onvif-zeep opencv-python numpy
    ```

2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ffmpeg (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ç–æ–∫–∞ —á–µ—Ä–µ–∑ ffprobe):
    ```bash
    sudo apt install ffmpeg
    ```

3. –ü–æ–º–µ—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `externalscripts` Zabbix —Å–µ—Ä–≤–µ—Ä–∞:
    ```bash
    cp camera_audit.py /usr/lib/zabbix/externalscripts/
    chmod +x /usr/lib/zabbix/externalscripts/camera_audit.py
    ```

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```bash
./camera_audit.py <IP-–∞–¥—Ä–µ—Å –∫–∞–º–µ—Ä—ã>
```

–ù–∞ –≤—ã—Ö–æ–¥–µ —Å–∫—Ä–∏–ø—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON, –Ω–∞–ø—Ä–∏–º–µ—Ä:

```json
{
  "Manufacturer": "Hikvision",
  "Model": "DS-2CD2142FWD",
  "FirmwareVersion": "V5.5.0",
  "TimeSyncOK": true,
  "RTSPPort": 554,
  "status": "ok",
  "real_fps": 24.5,
  "avg_brightness": 112.3
}
```

---

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Zabbix

- –¢–∏–ø —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–∞–Ω–Ω—ã—Ö: `External Check`
- –ö–ª—é—á –≤—ã–∑–æ–≤–∞:  
  ```bash
  camera_audit.py["{HOST.IP}"]
  ```
- –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö: **–¢–µ–∫—Å—Ç**
- –ü—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–µ:
  - **JSONPath** –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –Ω—É–∂–Ω—ã—Ö –ø–æ–ª–µ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, `$.status`, `$.TimeSyncOK`).

–ù–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª–µ–π –º–æ–∂–Ω–æ —Å—Ç—Ä–æ–∏—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä—ã:
- "–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ ONVIF"
- "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è RTSP-–ø–æ—Ç–æ–∫–∞"
- "–û–±–Ω–∞—Ä—É–∂–µ–Ω –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –∫–∞–º–µ—Ä–µ"
- "–°–∏–ª—å–Ω–æ–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏"

---

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –û–ø–∏—Å–∞–Ω–∏–µ | –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é |
|:--------|:---------|:---------------------|
| `ALLOWED_TIME_DIFF_SECONDS` | –î–æ–ø—É—Å—Ç–∏–º–æ–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ UTC, —Å–µ–∫ | `120` |
| `PORTS_TO_CHECK` | –°–ø–∏—Å–æ–∫ –ø–æ—Ä—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ ONVIF | `[80, 8000, 8080, 8899, 10554, 10080, 554, 37777, 5000, 443]` |
| `PASSWORDS` | –°–ø–∏—Å–æ–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ | `["admin", "12345678", "Iwec83jd23"]` |

---

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

**–í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã!**

- Python 3.6+
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Python:
  - `onvif` (–ø–∞–∫–µ—Ç `onvif-zeep`)
  - `opencv-python`
  - `numpy`
  - `zeep`
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `ffmpeg` (–¥–ª—è –æ–ø—Ü–∏–∏ fallback-–ø—Ä–æ–≤–µ—Ä–∫–∏ RTSP —á–µ—Ä–µ–∑ ffprobe)

**–¢–∞–∫–∂–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
- `sys`
- `json`
- `datetime`
- `socket`
- `os`
- `subprocess`
- `time`
- `cv2`
- `numpy`
- `urllib.parse`
- `onvif`
- `zeep`

---

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License.

---

## –ê–≤—Ç–æ—Ä—ã

- [–í–∞—à–µ –ò–º—è –∏–ª–∏ –ù–∏–∫–Ω–µ–π–º](https://github.com/yourusername)

---

*(–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Ç–∞–∫–∂–µ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã –≤—ã–≤–æ–¥–∞ —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞ –∏ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è Zabbix)*

